# Load required libraries
library(dplyr)
library(psych)   # For descriptive statistics
library(lavaan)  # For SEM analysis

# 1. Set seed for reproducibility and simulate data for 324 students
set.seed(123)
n <- 324
data <- data.frame(
  id = 1:n,
  sex = sample(c("M", "F"), n, replace = TRUE),
  age = sample(14:19, n, replace = TRUE),
  grade = sample(9:12, n, replace = TRUE),
  academic_scores = round(rnorm(n, mean = 75, sd = 10), 1)
)

# 2. Random allocation to treatment (1) and control (0) groups
data$treatment <- sample(c(0, 1), n, replace = TRUE)

# 3. Simulate pre-test scores (loneliness, social anxiety, POSI, PIU)
data$loneliness_pre <- round(rnorm(n, mean = 50, sd = 10), 1)
data$social_anxiety_pre <- round(rnorm(n, mean = 50, sd = 10), 1)
data$POSI_pre <- round(rnorm(n, mean = 50, sd = 10), 1)
data$PIU_pre <- round(rnorm(n, mean = 50, sd = 10), 1)

# 4. Simulate post-test scores
# For the treatment group, assume the ICBT treatment reduces the scores by an average effect.
# For the control group, the scores remain similar (with some noise).

data$loneliness_post <- with(data, ifelse(treatment == 1,
                                            loneliness_pre - rnorm(n, mean = 5, sd = 3),
                                            loneliness_pre + rnorm(n, mean = 0, sd = 3)))
data$social_anxiety_post <- with(data, ifelse(treatment == 1,
                                              social_anxiety_pre - rnorm(n, mean = 5, sd = 3),
                                              social_anxiety_pre + rnorm(n, mean = 0, sd = 3)))
data$POSI_post <- with(data, ifelse(treatment == 1,
                                    POSI_pre - rnorm(n, mean = 5, sd = 3),
                                    POSI_pre + rnorm(n, mean = 0, sd = 3)))
data$PIU_post <- with(data, ifelse(treatment == 1,
                                   PIU_pre - rnorm(n, mean = 5, sd = 3),
                                   PIU_pre + rnorm(n, mean = 0, sd = 3)))

# 5. Descriptive statistics for the dataset
desc_stats <- describe(data)
print(desc_stats)

# 6. ANCOVA: Compare post-test loneliness scores controlling for the pre-test score
ancova_model <- aov(loneliness_post ~ treatment + loneliness_pre + sex + age + grade + academic_scores, data = data)
summary(ancova_model)

# 7. SEM Mediation Analysis using lavaan
# The model tests whether POSI mediates the effects of loneliness and social anxiety on PIU.
# Paths: loneliness_post and social_anxiety_post predict POSI_post; POSI_post then predicts PIU_post.
model <- '
  # Direct effects on mediator
  POSI_post ~ a1*loneliness_post + a2*social_anxiety_post
  
  # Direct effects on outcome
  PIU_post ~ b*POSI_post + c1*loneliness_post + c2*social_anxiety_post
  
  # Indirect effects (mediation effects)
  indirect_loneliness := a1 * b
  indirect_social_anxiety := a2 * b
'
fit <- sem(model, data = data)
summary(fit, standardized = TRUE, fit.measures = TRUE)
